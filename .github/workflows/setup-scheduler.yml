name: Setup EC2 Scheduler & CloudFront Auto-Update

# Execução manual — rode UMA VEZ após configurar as secrets e o CloudFront.
# Actions → Setup EC2 Scheduler & CloudFront Auto-Update → Run workflow
#
# Secrets necessários (Settings → Secrets and variables → Actions):
#   AWS_ROLE_ARN               — ARN da role OIDC (já existe)
#   EC2_INSTANCE_ID            — ID da instância EC2 (já existe)
#   APP_DIR                    — Diretório da app na EC2 (já existe, ex: /opt/pequenos-grupos)
#   CLOUDFRONT_DISTRIBUTION_ID — ID da distribuição (ex: EDFDVBD6EXAMPLE)
#   CLOUDFRONT_ORIGIN_ID       — ID do origin dentro da distribuição
#   CLOUDFRONT_URL             — URL pública do CloudFront (ex: https://d1234.cloudfront.net)

on:
  workflow_dispatch:
    inputs:
      run_now:
        description: "Executar update-origin.sh imediatamente após instalar (recomendado para testar)"
        type: boolean
        default: true
      skip_fix_url:
        description: "Pular a migração do NEXT_PUBLIC_APP_URL (se já foi feita anteriormente)"
        type: boolean
        default: false
      skip_install:
        description: "Pular a instalação do update-origin.service (se já foi instalado)"
        type: boolean
        default: false

env:
  AWS_REGION: us-east-1
  APP_DIR: ${{ secrets.APP_DIR || '/opt/pequenos-grupos' }}

permissions:
  id-token: write
  contents: read

jobs:
  # ─────────────────────────────────────────────────────────────────────────
  # JOB 1: Migrar NEXT_PUBLIC_APP_URL para URL fixa do CloudFront
  # ─────────────────────────────────────────────────────────────────────────
  fix-app-url:
    name: "1/2 — Migrar NEXT_PUBLIC_APP_URL para CloudFront"
    runs-on: ubuntu-latest
    if: ${{ inputs.skip_fix_url == false }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configurar credenciais AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Validar secrets obrigatórias
        run: |
          ERRORS=0
          [ -z "${{ secrets.EC2_INSTANCE_ID }}" ]   && echo "ERRO: secret EC2_INSTANCE_ID não definida"   && ERRORS=$((ERRORS+1))
          [ -z "${{ secrets.CLOUDFRONT_URL }}" ]     && echo "ERRO: secret CLOUDFRONT_URL não definida"     && ERRORS=$((ERRORS+1))
          [ $ERRORS -gt 0 ] && exit 1
          echo "Secrets validadas."

      - name: Tornar scripts executáveis
        run: chmod +x scripts/fix-app-url.sh

      - name: Migrar NEXT_PUBLIC_APP_URL
        run: |
          ./scripts/fix-app-url.sh \
            --cloudfront-url "${{ secrets.CLOUDFRONT_URL }}" \
            --instance-id    "${{ secrets.EC2_INSTANCE_ID }}" \
            --app-dir        "${{ env.APP_DIR }}" \
            --ssm-path       "/pequenos-grupos" \
            --region         "${{ env.AWS_REGION }}"

  # ─────────────────────────────────────────────────────────────────────────
  # JOB 2: Instalar update-origin.service na EC2
  # ─────────────────────────────────────────────────────────────────────────
  install-update-origin:
    name: "2/2 — Instalar update-origin.service na EC2"
    runs-on: ubuntu-latest
    needs: fix-app-url
    # Roda mesmo se o job anterior foi pulado (skip_fix_url=true)
    if: |
      always() &&
      inputs.skip_install == false &&
      (needs.fix-app-url.result == 'success' || needs.fix-app-url.result == 'skipped')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configurar credenciais AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Validar secrets obrigatórias
        run: |
          ERRORS=0
          [ -z "${{ secrets.EC2_INSTANCE_ID }}" ]            && echo "ERRO: secret EC2_INSTANCE_ID não definida"            && ERRORS=$((ERRORS+1))
          [ -z "${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}" ] && echo "ERRO: secret CLOUDFRONT_DISTRIBUTION_ID não definida" && ERRORS=$((ERRORS+1))
          [ -z "${{ secrets.CLOUDFRONT_ORIGIN_ID }}" ]       && echo "ERRO: secret CLOUDFRONT_ORIGIN_ID não definida"       && ERRORS=$((ERRORS+1))
          [ $ERRORS -gt 0 ] && exit 1
          echo "Secrets validadas."

      - name: Tornar scripts executáveis
        run: chmod +x scripts/install-update-origin-service.sh scripts/update-origin.sh

      - name: Instalar update-origin.service na EC2
        run: |
          RUN_NOW_FLAG=""
          if [ "${{ inputs.run_now }}" = "true" ]; then
            RUN_NOW_FLAG="--run-now"
          fi

          ./scripts/install-update-origin-service.sh \
            --instance-id     "${{ secrets.EC2_INSTANCE_ID }}" \
            --distribution-id "${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}" \
            --origin-id       "${{ secrets.CLOUDFRONT_ORIGIN_ID }}" \
            --app-dir         "${{ env.APP_DIR }}" \
            --ssm-path        "/pequenos-grupos" \
            --region          "${{ env.AWS_REGION }}" \
            $RUN_NOW_FLAG

      - name: Resumo final
        if: success()
        run: |
          echo "## Setup concluído!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "O serviço \`update-origin.service\` está instalado e habilitado na EC2." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**A partir de agora, a cada boot da EC2:**" >> $GITHUB_STEP_SUMMARY
          echo "- O CloudFront origin é atualizado automaticamente com o novo DNS da instância" >> $GITHUB_STEP_SUMMARY
          echo "- Os parâmetros SSM \`/pequenos-grupos/app/ec2-dns\` e \`/pequenos-grupos/app/ec2-ip\` são atualizados" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Para consultar o log do script na EC2:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "aws ssm send-command \\" >> $GITHUB_STEP_SUMMARY
          echo "  --instance-ids ${{ secrets.EC2_INSTANCE_ID }} \\" >> $GITHUB_STEP_SUMMARY
          echo "  --document-name AWS-RunShellScript \\" >> $GITHUB_STEP_SUMMARY
          echo "  --parameters 'commands=[\"cat /var/log/update-origin.log\"]' \\" >> $GITHUB_STEP_SUMMARY
          echo "  --region ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
