version: 1

# AWS Amplify Build Configuration
# DocumentaÃ§Ã£o: https://docs.aws.amazon.com/amplify/latest/userguide/build-settings.html

frontend:
  phases:
    preBuild:
      commands:
        - echo "ðŸ“¦ Installing dependencies..."
        - node --version
        - npm --version
        - npm ci
        
    build:
      commands:
        - echo "ðŸ”¨ Building Next.js application..."
        - npm run build
        - echo "âœ… Build completed successfully!"
        
    postBuild:
      commands:
        - echo "ðŸ§¹ Post-build cleanup..."
        - echo "ðŸ“Š Build statistics:"
        - du -sh .next/
        
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
      
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
      - ~/.npm/**/*

# Custom Headers para SeguranÃ§a
customHeaders:
  - pattern: '**/*'
    headers:
      # HTTPS Enforcement
      - key: 'Strict-Transport-Security'
        value: 'max-age=31536000; includeSubDomains; preload'
      
      # Frame Protection (previne clickjacking)
      - key: 'X-Frame-Options'
        value: 'DENY'
      
      # Content Type Sniffing Protection
      - key: 'X-Content-Type-Options'
        value: 'nosniff'
      
      # XSS Protection
      - key: 'X-XSS-Protection'
        value: '1; mode=block'
      
      # Referrer Policy
      - key: 'Referrer-Policy'
        value: 'strict-origin-when-cross-origin'
      
      # Content Security Policy
      - key: 'Content-Security-Policy'
        value: "default-src 'self'; script-src 'self' 'unsafe-eval' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://*.supabase.co wss://*.supabase.co https://wa.me; frame-ancestors 'none';"
      
      # Permissions Policy
      - key: 'Permissions-Policy'
        value: 'camera=(), microphone=(), geolocation=(), interest-cohort=()'

  # Cache Control para Performance
  - pattern: '/static/**'
    headers:
      - key: 'Cache-Control'
        value: 'public, max-age=31536000, immutable'
  
  - pattern: '/_next/static/**'
    headers:
      - key: 'Cache-Control'
        value: 'public, max-age=31536000, immutable'
  
  - pattern: '/icons/**'
    headers:
      - key: 'Cache-Control'
        value: 'public, max-age=86400, stale-while-revalidate=3600'

# Environment Variables (carregadas do SSM Parameter Store)
# Configurar em: Amplify Console â†’ App Settings â†’ Environment Variables
# Use prefixo _ssm: para carregar do Parameter Store
# Exemplo: _ssm:/pequenos-grupos/prod/NEXT_PUBLIC_SUPABASE_URL
